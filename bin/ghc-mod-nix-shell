#!/usr/bin/env bash

# Source .bashrc because this script is intended to be
# used by editors, e.g. Atom which doesn't source .bashrc,
# and we need NIX_PATH to be set correctly.
source ~/.bashrc

# Walk up the FS hierarchy until we find a shell.nix or stack.yaml
while [ "$PWD" != "/" ] && [ ! -f shell.nix ] && [ ! -f stack.yaml ]; do
    cd ..
done

# If we didn't find either, give up.
if [ -f shell.nix ]; then

  # Arg list trick:
  # https://stackoverflow.com/questions/3104209
  ARGS=$(printf "%q"" " "$@")

  # Run ghc-mod inside nix-shell
  nix-shell --run "ghc-mod $ARGS"

elif [ -f stack.yaml ]; then

  ghc-mod "$@"

else
  (>&2 echo "No shell.nix or stack.yaml found")
  exit 1
fi
